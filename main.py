
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from pydantic import BaseModel, field_validator
from typing import List, Optional
from openpyxl import load_workbook
import math, os

app = FastAPI(title="Charity's Measure App", version="0.10.0")
app.mount('/static', StaticFiles(directory='static'), name='static')
templates = Jinja2Templates(directory='templates')

DATA_PATH = os.path.join('data', 'CHARITYS_MEASURE.xlsx')
wb = load_workbook(DATA_PATH, data_only=False)
ws_inputs = wb['Charitys Inputs']
ws_measure = wb['Charitys Measure']
ws_script = wb['Scripture Inputs']

LABELS = ["NEVER ", "NEVER SEEK YOUR", "NOT EASILY", "YOU ARE LONG", "YOU ARE NEVER", "YOU ARE NEVER", "YOU ARE ALWAYS", "YOU NEVER ACT"]
INPUTS_MAP = [[0.0, "YOU ARE PURE EVIL,", "AND, YOU ARE SATAN!!!"], [0.1, "YOU ARE PURE EVIL,", "AND, YOU MAY BE THE BEAST!!!"], [0.2, "YOU ARE PURE EVIL,", "AND, YOU ARE HANDING OUT LEAFLETS OF THE FALSE PROPHET!!!"], [0.3, "YOU ARE PURE EVIL,", "AND, YOU ARE COUNTED IN AS THE SPAWN OF SATAN!!!"], [0.4, "YOU ARE PURE EVIL,", "AND, YOU ARE IN THE SADDLE BAGS OF THE WHITE HORSE CONQUERING ALL!!!"], [0.5, "YOU ARE PURE EVIL,", "AND, YOU ARE IN THE SADDLE BAGS OF THE RED HORSE TO TAKE PEACE FROM THE EARTH!!!"], [0.6, "YOU ARE PURE EVIL,", "AND, YOU ARE IN THE SADDLE BAGS OF THE BLACK HORSE STEALING THE WEALTH OF THE WORLD!!!"], [0.7, "YOU ARE PURE EVIL,", "AND, YOU ARE IN THE  SADDLE BAGS OF THE PALE HORSE WITH DEATH AND HELL FOLLOWING!!!"], [0.7999999999999999, "YOU ARE PURE EVIL,", "AND, YOU ARE A GRIEVOUS SORE BEARING THE MARK OF THE BEAST!!!"], [0.8999999999999999, "YOU ARE PURE EVIL,", "AND, YOU PARTICIPATE IN THE BLOOD OF A DEAD MAN KILLING ALL THAT YOU SEE!!!"], [0.9999999999999999, "YOU ARE EVIL,", "AND, YOU CHEER FOR THE BLOODSHED OF THE SAINTS!!!"], [1.0999999999999999, "YOU ARE EVIL,", "AND, YOU PARTICIPATE IN THE EVIL SCORCH OF FIRE AND TORMENT TO MANKIND!!!"], [1.2, "YOU ARE EVIL,", "AND, YOU PARTICIPATE IN THE EVIL PAINS AND SORES KNAWING AT MANKIND!!!"], [1.3, "YOU ARE EVIL,", "AND, YOU ARE THE VIAL OF THE DRY EUPHRATES MAKING THE WAY OF THE EVIL DOERS!!!"], [1.4000000000000001, "YOU ARE EVIL,", "AND, YOU ARE THE FIRST UNCLEAN FROG FROM THE FOUL MOUTH OF THE DRAGON!!!"], [1.5000000000000002, "YOU ARE EVIL,", "AND, YOU ARE THE SECOND UNCLEAN FROG FROM THE FOUL MOUTH OF THE DRAGON!!!"], [1.6000000000000003, "YOU ARE EVIL,", "AND, YOU ARE THE THIRD UNCLEAN FROG FROM THE FOUL MOUTH OF THE DRAGON!!!"], [1.7000000000000004, "YOU ARE EVIL,", "AND, YOU WILL BE CONSUMED IN THE GREAT HAIL FROM HEAVEN!!!"], [1.8000000000000005, "YOU ARE EVIL,", "AND, THE GREAT WHORE OF THE ALL THE WORLD GIVES YOU HER NUMBER!!!"], [1.9000000000000006, "YOU ARE EVIL,", "AND, THE MOTHER OF HARLOTS REVELS IN THE PAIN YOU CAUSE!!!"], [2.0000000000000004, "YOU ARE CHOOSING EVIL,", "AND, YOU ARE DRUNKEN WITH THE BLOOD OF THE SAINTS!!!"], [2.1000000000000005, "YOU ARE CHOOSING EVIL,", "AND, THE MOTHER OF ABOMINATIONS OF THE WORLD HAS ADOPTED YOU!!!"], [2.2000000000000006, "YOU ARE CHOOSING EVIL,", "AND, YOU ARE NOW A FULLY COUPLED DISCIPLE OF THE DEVIL!!!"], [2.3000000000000007, "YOU ARE CHOOSING EVIL,", "AND, YOUR REJECTION OF THE PRINCIPLES OF LOVE ARE NEARING THE POINT OF NO REDEMPTION!!!"], [2.400000000000001, "YOU ARE CHOOSING EVIL,", "AND, YOUR WORLD HAS BECOME FULLY DARK AND LONELY!!!"], [2.500000000000001, "YOU ARE CHOOSING EVIL,", "AND, THE LOVE OF GOD IS BARELY RECOGNIZABLE TO YOU NOW!!!"], [2.600000000000001, "YOU ARE CHOOSING EVIL,", "AND, DARKNESS HAS CONSUMED THE SPACE THAT YOU SHARE WITH IT!!!"], [2.700000000000001, "YOU ARE CHOOSING EVIL,", "AND, DARKNESS IS COURTING YOU FOREVER MORE!!!"], [2.800000000000001, "YOU ARE CHOOSING EVIL,", "AND, DARKNESS IS WELCOMED INTO YOUR LIFE!!!"], [2.9000000000000012, "YOU ARE CHOOSING EVIL,", "AND YOU'RE NOT TO GOOD AT IT!!!"], [3.0000000000000013, "YOU ARE CHOOSING EVIL,", "AND YOU ARE OPENING THE DOOR!!!"], [3.1000000000000014, "YOU HAVE WANDERED FAR OFF THE PATH OF RIGHTEOUSNESS", "AND, DARKNESS IS TRACKING YOU!!!"], [3.2000000000000015, "A FALSE PROMISE IS BEING OFFERED", "AND, EVIL AND ENMITY BECKON YOU!!!"], [3.3000000000000016, "SOMETHING IS BEING OFFERED", "AND, YOU BEGIN TO HEAR CLEARLY THE EVIL THAT WHISPERS TO YOU!!!"], [3.4000000000000017, "SOMETHING IS WRONG", "AND, YOU BEGIN TO COMPLAIN AND DESIRE MORE!!!"], [3.5000000000000018, "YOU ARE LOST", "AND, YOU EMBRACE SELFISHNESS!!!"], [3.600000000000002, "SELFISHNESS IS UPON YOU", "AND, YOU ARE BEGINNING TO ENJOY IT!!!"], [3.700000000000002, "SELFISHNESS IS UPON YOU", "AND, YOU ARE FULL OF VANITY AND PRIDE!!!"], [3.800000000000002, "SELFISHNESS IS UPON YOU", "AND, THERE IS NO ROOM FOR OTHERS!!!"], [3.900000000000002, "WICKED DARTS OF DARKNESS", "AND, YOU CHOOSE THE WRONG OVER THE RIGHT!!!"], [4.000000000000002, "BREASTPLATE OF RIGHTEOUSNESS", "AND, NOW… YOU MUST MAKE A CHOICE NOW!!!"], [4.100000000000001, "SWORD OF YOUR TRUTH", "AND, YOU WEIGH THE PROMISE OF QUITTING TO ENDURING IN PAIN!!!"], [4.200000000000001, "BOW AND ARROWS OF FURTHER LIGHT AND KNOWLEDGE", "AND, YOU ARE EMBRACING FEAR AND TERROR OVER STEADY DISCIPLINED COMEBACK!!!"], [4.300000000000001, "BOW AND ARROWS OF FURTHER LIGHT AND KNOWLEDGE", "AND, YOU SURRENDER TO GUILT AND SHAME!!!"], [4.4, "SWORD OF YOUR TRUTH", "AND, YOU SLIPPED! YOU GO OVER THE EDGE IN DEFEAT!, SEEYA:)"], [4.5, "SWORD OF YOUR TRUTH", "AND, THE MOMENT IS NEARING THAT YOU ARE NOT SURE YOU CAN MAINTAIN!"], [4.6, "YOUR IMMATURITY IS REVEALED", "AND, YOU FALL AND STRUGGLE BEING LUKE WARM AND NEITHER COLD NOR HOT!!!"], [4.699999999999999, "YOUR IMMATURITY IS REVEALED", "AND, YOU NOW WRESTLE WITH THE PROMISE OF RIGHTEOUSNESS!!!"], [4.799999999999999, "SWORD OF YOUR TRUTH", "AND, YOU ARE TRYING TO LEARN AND GROW, BUT SO TIRED!!!"], [4.899999999999999, "SHEILD OF FAITH", "AND, YOU ARE FEELING THE PAIN OF SELF-DISCIPLINE CALLING YOU TO GROW!!!"], [4.999999999999998, "SWORD OF YOUR TRUTH", "AND, YOU ONLY HOPE TO ENDURE THE UNKNOWN AHEAD!!!"], [5.099999999999998, "SPEAR OF YOUR LIFE'S DESTINY", "AND, YOU RECOGNIZE THE STEEP CLIMB OF FURTHER LIGHT AND PERFECTION AHEAD OF YOU!!!"], [5.1999999999999975, "SWORD OF YOUR TRUTH", "AND, YOU ARE CONFRONTED WITH YOUR OWN EGO AND VANITY IN BEING WEAK!!!"], [5.299999999999997, "BOW AND ARROWS OF FURTHER LIGHT AND KNOWLEDGE", "AND, YOU ARE RECOGNIZING THE NEED FOR HELP BY OTHERS!!!"], [5.399999999999997, "SWORD OF YOUR TRUTH", "AND, THE WEIGHT OF YOUR INTELLIGENCE IS BEING MEASURED BY YOU!!!"], [5.4999999999999964, "SWORD OF YOUR TRUTH", "AND, NOW YOU MUST OVERCOME YOUR FEAR OF THE WRONG CHOICES IN LIFE!!!"], [5.599999999999996, "HELMET OF SALVATION", "AND, NOW… YOU MUST LISTEN TO THE STILL SMALL VOICE AND CHOOSE WISELY!!!"], [5.699999999999996, "BREASTPLATE OF RIGHTEOUSNESS", "AND, YOU ARE GIVEN THE CHOICE TO CLIMB OR DESCEND IN YOUR THINKING!!!"], [5.799999999999995, "HELMET OF SALVATION", "AND, WOW, YOU NOW KNOW SOMETHING YOU DIDN'T KNOW!!!"], [5.899999999999995, "HELMET OF SALVATION", "GOOD NEWS, IGNORANCE IS TEMPORARY, STUPID DOESN'T HAVE TO BE FOREVER!"], [5.999999999999995, "THE SWORD OF YOUR TRUTH", "IS CUTTING DEEP.  YOUR IGNORANCE IS REVEALED AND CHOOSING \"THE WHO OF YOU\" IS NEAR!"], [6.099999999999994, "THE SWORD OF YOUR TRUTH", "AND, ENDURING ALL THINGS MUST BE YOUR HOPE NOW!!!"], [6.199999999999994, "THE SWORD OF YOUR TRUTH", "AND, CRITICAL ACTIONS MUST BE TAKEN TO TURN THE TIDE OF HOPE IN YOUR FAVOR!!!"], [6.299999999999994, "REFINER'S FIRE", "AND, YOU MUST SEEK FURTHER LIGHT AND PERFECTION NOW!!!"], [6.399999999999993, "HELMET OF SALVATION", "AND, YOUR KNOWLEDGE BASE IS BECOMING BARREN AND UNDERSTANDING IS FLEETING AT THIS TIME!!!"], [6.499999999999993, "HELMET OF SALVATION", "AND, FOCUS, ORGANIZING A NEW VISION FOR YOUR LIFE IS ABSOLUTELY REQUIRED!!!"], [6.5999999999999925, "HELMET OF SALVATION", "AND, YOUR UNDERSTANDING IS FAILING YOU AND YOU NOW KNOW IT!!!"], [6.699999999999992, "HELMET OF SALVATION", "AND, YOUR DECISIONS ARE UNCLEAR, DIVIDED AND UNSURE!!!"], [6.799999999999992, "HELMET OF SALVATION", "AND, YOUR COURAGE IS WAINING, STEADY AS SHE GOES SEEMS IMPOSSIBLE!!!"], [6.8999999999999915, "HELMET OF SALVATION", "AND, A NEW VISION FOR YOUR LIFE IS NEEDED NOW OR ALL CAN BE LOST!!!"], [6.999999999999991, "HELMET OF SALVATION", "IS NEAR, CRITICAL ATTITUDE ACKNOWLEDGED, WINGS LEVEL NEEDED NOW!!!"], [7.099999999999991, "HELMET OF SALVATION", "AND THE INCIPIENT SINS ARE CREEPING IN UPON YOU!!!"], [7.19999999999999, "HELMET OF SALVATION", "AND, YOU STRUGGLING NOW TO CHOOSE BETWEEM THE WRONG WAY TO GO AND THE RIGHT!!!"], [7.29999999999999, "HELMET OF SALVATION", "AND, CHOOSING THE RIGHT HAS COME INTO QUESTION!!!"], [7.39999999999999, "HELMET OF SALVATION", "AND, YOU ARE STARTING TO QUESTION THE GREY AREAS IN RIGHTEOUSNESS!!!"], [7.499999999999989, "HELMET OF SALVATION", "AND, THE ROCKS AND HARD PLACES IN LIFE SEEM TO BE CLOSE MORE OFTEN THAN NOT!!!"], [7.599999999999989, "HELMET OF SALVATION", "AND, THOUGH YOU ARE THRIVING, YOU ARE QUESTIONING SOME OF THE WHY'S IN YOUR LIFE!!!"], [7.699999999999989, "HELMET OF SALVATION", "AND, THOUGH THINGS SEEM TO BE GOING FORWARD, SOMETHING IS MISSING!!!"], [7.799999999999988, "HELMET OF SALVATION", "AND, THE WORLD SEEMS DIFFERENT, AND IT'S TIME TO REVIEW THE BASICS OF  LOVE!!!"], [7.899999999999988, "HELMET OF SALVATION", "YOU ARE QUESTIONING WHETHER ANYBODY ELSE REALLY CARES!!!"], [7.999999999999988, "GOOD JOB", "YOU LOVE OTHERS AS YOU LOVE YOURSELF!!!"], [8.099999999999987, "GOOD JOB", "YOU LOVE OTHERS AND MAKE A FEW MISTAKES IN GIVING AND RECEIVING!!!"], [8.199999999999987, "GOOD JOB", "YOU LOVE OTHERS AND RARELY MAKE MISTAKES IN GIVING AND RECEIVING!!!"], [8.299999999999986, "GOOD JOB", "YOU LOVE OTHERS AND TRULY CARE FOR THEM!!!"], [8.399999999999986, "GREAT JOB", "YOU FOUND YOUR PATH IN LIFE AND LOVE CHAMPIONS YOUR WAY!!!"], [8.499999999999986, "GREAT JOB", "YOU ARE LIVING THE LIFE YOU ARE CALLED TO WITHOUT SELFISHNESS!!!"], [8.599999999999985, "GREAT JOB", "YOU ARE A GREAT TEACHER IN LIFE!!!"], [8.699999999999985, "EXCELLENT JOB", "YOU ARE A STANDARD OF EXCELLENCE TO YOUR FAMILY, FRIENDS, AND FELLOWMAN!!!"], [8.799999999999985, "EXCELLENT JOB", "YOU ARE A PROFIT TO ALL WHO KNOW YOU!!!"], [8.899999999999984, "EXCELLENT JOB", "YOU LOVE THE ONE'S YOU'RE WITH VERSUS HATE THE ONES YOU'RE WITH!"], [8.999999999999984, "EXCELLENT SAINT", "YOU ARE LOVING OTHERS AS JESUS HAS LOVED YOU!"], [9.099999999999984, "EXCELLENT SAINT", "JESUS, THIS PERSON IS A WATCHMAN, A BROTHER, A SISTER, A SAINT!!!"], [9.199999999999983, "EXCELLENT SAINT", "JESUS, HOW BEAUTIFUL THE DAY, HOW BEAUTIFUL THE WAY I SEE IN THIS PERSON!!!"], [9.299999999999983, "EXCELLENT SAINT", "JESUS, THANK YOU FOR BEING THE GOD OF ORDER AND EXCELLENCE THAT I SEE IN THIS PERSON!!!"], [9.399999999999983, "EXCELLENT SAINT", "JESUS, SEE'S US,FREE'S US, HE'S US, THANK YOU FOR THIS PERSON WHO'S LOVE NEEDS US!!!"], [9.499999999999982, "EXCELLENT SAINT", "JESUS, THANK YOU FOR PUTTING THIS PERSON IN MY LIFE TODAY!!!"], [9.599999999999982, "EXCELLENT SAINT", "JESUS, THIS PERSON IS RESTORING MY BELIEF IN MANKIND!!!"], [9.699999999999982, "EXCELLENT SAINT", "JESUS, JESUS… I KNOW NOT THE WORDS FOR THIS PERSON YOU'VE PUT INTO MY LIFE!!!"], [9.799999999999981, "PERFECT ONE", "JESUS…I BET THIS ONE GET'S RAPTURED!!!"], [9.89999999999998, "PERFECT ONE", "JESUS…THIS SAINT IS NEAR TO THE TRANSLATED POINT!"], [9.99999999999998, "PERFECT ONE", "JESUS…IS THAT YOU?"]]
SCRIPT_MAP = [[0.0, "Isaiah 14:9", " Hell from beneath is moved for thee to meet thee at thy coming: it stirreth up the dead for thee,"]]
R19_YES = "WELCOME BROTHER, WELCOME SISTER.  LET'S GO DOWN TO THE RIVER TO PRAY STUDYING ABOUT THE GOOD OLE WAY!!!"
R19_NO = "HELL HATH NO FURY LIKE… UUH, WAIT, UUH, WELL, I GUESS HELL, WOULD YOU LIKE TO RECONSIDER, THERE IS STILL TIME!!!"
R21_YES_REF = ""
R21_NO_REF = ""

def lookup_inputs(score10: float):
    best = INPUTS_MAP[0]
    for row in INPUTS_MAP:
        if row[0] <= score10:
            best = row
        else:
            break
    return best

def e18_lookup(d18: float) -> str:
    key = max(0.0, min(1.0, float(d18)))
    approx = math.floor(key*100+1e-9)/100.0
    target = round(approx*10, 1)
    return lookup_inputs(target)[2]

def scripture_lookup(d21: float):
    best = SCRIPT_MAP[0]
    for row in SCRIPT_MAP:
        if row[0] <= d21:
            best = row
        else:
            break
    return {'ref': best[1], 'text': best[2]}

class InputPayload(BaseModel):
    scores: List[Optional[float]]
    yn: str = ''

    @field_validator('yn')
    @classmethod
    def validate_yn(cls, v: str):
        if v is None:
            return ''
        v = v.strip()
        if v and v.lower() not in ('y','n'):
            raise ValueError("yn must be 'y' or 'n'")
        return v

@app.get('/', response_class=HTMLResponse)
async def index(request: Request):
    return templates.TemplateResponse('index.html', {'request': request, 'labels': LABELS})

@app.post('/calc', response_class=JSONResponse)
async def calc(payload: InputPayload):
    clean = [(v if v is not None else None) for v in payload.scores[:8]]
    ssum = sum(v for v in clean if isinstance(v, (int, float)))
    any_val = any(isinstance(v, (int, float)) for v in clean)
    d16 = math.ceil((ssum if any_val else 0) * 10)/10
    b17 = 81.0
    d18 = (d16 / b17) if any_val else 0.0
    yes = (payload.yn or '').lower() == 'y'
    d20 = (b17 - d16) if yes else 0.0
    d21 = (d16 + d20) if yes else ((d16 * d20) if (d18 < 0.2 and any_val) else d18)

    meanings = [ (("", "", "") if (v is None) else lookup_inputs(float(v))) for v in clean ]
    e18_text = (e18_lookup(d18) if any_val else "")
    scripture = scripture_lookup(d21)

    r19_msg = R19_YES if yes else (R19_NO if payload.yn != '' else '')

    # Row 22: blank until Y/N entered; then Y = Safe House, N = Damnation
    if (payload.yn or '') == '':
        row22 = {'left': '', 'right': ''}
    elif yes:
        row22 = {'left': 'CHRIST STATURED AND RAPTURED', 'right': 'WELCOME TO THE SAFE HOUSE OF THE LORD'}
    else:
        row22 = {'left': 'YOU ARE NOT WRITTEN INTO THE BOOK OF LIFE:', 'right': 'WELCOME TO ETERNAL STATE OF DAMNATION'}

    return {
        'd16': d16, 'sum': ssum, 'b17': b17, 'd18': d18, 'd20': d20, 'd21': d21,
        'meanings': meanings, 'e18': e18_text, 'scripture': scripture, 'r19_msg': r19_msg, 'any': any_val,
        'r21_ref': (R21_YES_REF if yes else (R21_NO_REF if payload.yn != '' else '')),
        'row22': row22
    }
